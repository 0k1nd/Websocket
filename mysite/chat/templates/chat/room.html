<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>
    <h4>Привет, <span id="username"></span></h4>
    <textarea id="chat-log" cols="100" rows="20" readonly></textarea><br>
    <input id="chat-message-input" type="text" size="100" placeholder="Введите сообщение"><br>
    <button id="chat-message-submit">Отправить</button>

    <script>
        const room_pk = "{{ room.pk }}";
        const request_id = new Date().getTime();
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const token = localStorage.getItem('token');

        // Проверка наличия токена
        if (!token) {
            console.error('Токен не найден в LocalStorage!');
            alert('Вы не авторизованы! Пожалуйста, войдите в систему.');
            window.location.href = '/login';
        } else {
            console.log('Токен найден:', token);
        }

        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Функция подключения WebSocket с автоматическим переподключением
        function connectWebSocket() {
            const chatSocket = new WebSocket(`${protocol}://${window.location.host}/ws/chat/?token=${token}`);

            chatSocket.onopen = function () {
                console.log('WebSocket соединение открыто.');
                reconnectAttempts = 0;

                chatSocket.send(JSON.stringify({ pk: room_pk, action: "join_room", request_id }));
                chatSocket.send(JSON.stringify({ pk: room_pk, action: "retrieve", request_id }));
            };

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);

                switch (data.action) {
                    case "retrieve":
                        document.getElementById('username').innerText = data.data.host.username;
                        for (let mess of data.data.messages) {
                            appendMessage(mess.user.username, mess.text);
                        }
                        break;
                    case "create":
                        appendMessage(data.data.user.username, data.data.text);
                        break;
                    case "error":
                        alert(`Ошибка: ${data.message}`);
                        break;
                    default:
                        console.log("Получено сообщение:", data);
                }
            };

            chatSocket.onclose = function () {
                console.error('Соединение потеряно.');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Попытка переподключения ${reconnectAttempts} из ${maxReconnectAttempts}...`);
                    setTimeout(connectWebSocket, 3000);
                } else {
                    alert('Не удалось восстановить соединение с сервером. Пожалуйста, перезагрузите страницу.');
                }
            };

            chatSocket.onerror = function (error) {
                console.error('Ошибка WebSocket:', error);
            };

            // Обработка отправки сообщений
            document.getElementById('chat-message-submit').onclick = function () {
                const messageInput = document.getElementById('chat-message-input');
                const message = messageInput.value.trim();

                if (message.length === 0) {
                    alert("Сообщение не может быть пустым!");
                    return;
                }

                chatSocket.send(JSON.stringify({ message, action: "create_message", request_id }));
                messageInput.value = '';
            };

            // Отправка по нажатию Enter
            document.getElementById('chat-message-input').onkeyup = function (e) {
                if (e.key === 'Enter') {
                    document.getElementById('chat-message-submit').click();
                }
            };
        }

        // Функция для добавления сообщений в лог
        function appendMessage(username, message) {
            const chatLog = document.getElementById('chat-log');
            chatLog.value += `${username}: ${message}\n`;
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Запуск подключения WebSocket
        connectWebSocket();
    </script>
</body>
</html>
